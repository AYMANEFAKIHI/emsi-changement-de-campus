<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMSI Echange de Campus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4;
        }
        .container {
            max-width: 800px;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #d1fae5;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #34d399;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #10b981;
        }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-green-50 flex flex-col min-h-screen p-4">

    <div class="container mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-10 my-8 flex-grow">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-green-800 mb-2">EMSI Echange de Campus</h1>
            <p class="text-gray-600">Partagez votre demande d'échange avec d'autres étudiants.</p>
        </header>
        
        <div id="status-message" class="hidden mb-4 p-4 text-center rounded-lg text-sm font-medium" role="alert"></div>

        <div class="mb-10 p-6 bg-white rounded-xl border border-green-200 shadow-md">
            <h2 class="text-2xl font-semibold text-green-700 mb-4">Publier votre demande</h2>
            <form id="request-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="prenom" class="block text-sm font-medium text-gray-700">Prénom</label>
                        <input type="text" id="prenom" required class="mt-1 block w-full rounded-md border-green-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                    </div>
                    <div>
                        <label for="nom" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="nom" required class="mt-1 block w-full rounded-md border-green-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="niveau" class="block text-sm font-medium text-gray-700">Niveau et filière</label>
                        <input type="text" id="niveau" required class="mt-1 block w-full rounded-md border-green-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                    </div>
                    <div>
                        <label for="ville" class="block text-sm font-medium text-gray-700">Ville</label>
                        <select id="ville" required class="mt-1 block w-full rounded-md border-green-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                            <option value="">Sélectionnez une ville</option>
                            <option value="TANGER">TANGER</option>
                            <option value="RABAT">RABAT</option>
                            <option value="MARRAKECH">MARRAKECH</option>
                            <option value="FES">FES</option>
                            <option value="CASABLANCA">CASABLANCA</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="campusActuel" class="block text-sm font-medium text-gray-700">Campus actuel</label>
                        <select id="campusActuel" required class="mt-1 block w-full rounded-md border-green-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                            <option value="">Sélectionnez un campus</option>
                        </select>
                    </div>
                    <div>
                        <label for="campusDesire" class="block text-sm font-medium text-gray-700">Campus souhaité</label>
                        <select id="campusDesire" required class="mt-1 block w-full rounded-md border-green-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                            <option value="">Sélectionnez un campus</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="numero" class="block text-sm font-medium text-gray-700">Numéro de téléphone</label>
                    <input type="tel" id="numero" required class="mt-1 block w-full rounded-md border-green-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                </div>

                <div class="flex space-x-2">
                    <button id="submit-btn" type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-green-700 transition duration-200 flex items-center justify-center">
                        <span id="submit-text">Publier</span>
                        <div id="submit-spinner" class="spinner hidden ml-2"></div>
                    </button>
                    <button type="button" id="clear-form-btn" class="w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-gray-300 transition duration-200">
                        Effacer
                    </button>
                </div>
            </form>
        </div>

        <div class="mb-10 p-6 text-center rounded-xl bg-green-100 border-green-300 border shadow-md">
            <p class="text-green-800 font-semibold text-lg mb-2">
                Aidez-nous à trouver plus de matchs!
            </p>
            <p class="text-green-700 mb-4">
                Partagez ce lien dans les groupes de vos classes pour que tous les étudiants
                qui souhaitent changer de campus puissent poster leur annonce rapidement.
            </p>
            <button id="copy-link-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-green-700 transition duration-200">
                <i class="fas fa-link mr-2"></i> Copier le lien
            </button>
        </div>

        <div class="mb-10 p-6 bg-white rounded-xl border border-green-200 shadow-md">
            <h2 class="text-2xl font-semibold text-green-700 mb-4">Trouver mon Match</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="searchVille" class="block text-sm font-medium text-gray-700">Rechercher par Ville</label>
                    <select id="searchVille" class="mt-1 block w-full rounded-md border-green-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                        <option value="">Sélectionnez une ville</option>
                        <option value="TANGER">TANGER</option>
                        <option value="RABAT">RABAT</option>
                        <option value="MARRAKECH">MARRAKECH</option>
                        <option value="FES">FES</option>
                        <option value="CASABLANCA">CASABLANCA</option>
                    </select>
                </div>
                <div>
                    <label for="searchCampus" class="block text-sm font-medium text-gray-700">Rechercher par Campus souhaité</label>
                    <select id="searchCampus" class="mt-1 block w-full rounded-md border-green-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                        <option value="">Sélectionnez un campus</option>
                    </select>
                </div>
            </div>
        </div>

        <div>
            <h2 class="text-2xl font-semibold text-green-700 mb-2">Demandes d'échange existantes</h2>
            <!-- Total count of requests added here -->
            <div class="mb-4 text-center text-gray-600 font-medium">
                <span id="total-requests">0</span> demandes au total.
            </div>
            <div id="requests-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div id="loading-requests" class="col-span-1 md:col-span-2 text-center text-gray-500 p-8">Chargement des demandes...</div>
            </div>
        </div>

        <!-- Custom message box for alert and confirm -->
        <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl shadow-lg text-center max-w-sm w-full">
                <p id="message-text" class="text-lg font-medium text-gray-800 mb-4"></p>
                <div class="flex justify-center space-x-2">
                    <button id="message-ok-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                        OK
                    </button>
                    <button id="message-cancel-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 hidden">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Footer with LinkedIn link -->
    <footer class="text-center text-sm text-gray-600 mt-8 mb-4">
        <p>Développé par <a href="https://www.linkedin.com/in/aymane-fakihi-9a3435335/" target="_blank" class="text-green-600 hover:text-green-800 transition-colors duration-200">Aymane Fakihi</a></p>
    </footer>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        const supabaseUrl = 'https://jropljlziznpzypvxjkw.supabase.co'; 
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impyb3Bsamx6aXpucHp5cHZ4amt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NjU4MDksImV4cCI6MjA3MzU0MTgwOX0.QVo5bdwTguruXeY5oTmePtcLq__A65zFT7zq0SFT0Lc'; 
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        let myUserId = localStorage.getItem('myUserId') || crypto.randomUUID();
        localStorage.setItem('myUserId', myUserId);
        
        const requestForm = document.getElementById('request-form');
        const requestsList = document.getElementById('requests-list');
        const loadingRequests = document.getElementById('loading-requests');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok-btn');
        const messageCancelBtn = document.getElementById('message-cancel-btn');
        const statusMessage = document.getElementById('status-message');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');
        const searchVilleInput = document.getElementById('searchVille');
        const searchCampusInput = document.getElementById('searchCampus');
        const submissionVilleInput = document.getElementById('ville');
        const submissionCampusActuelInput = document.getElementById('campusActuel');
        const submissionCampusDesireInput = document.getElementById('campusDesire');
        const totalRequestsSpan = document.getElementById('total-requests');
        let allRequests = [];

        
        const campusOptions = {
            'TANGER': ['TANGER'],
            'RABAT': ['CENTRE 1', 'CENTRE 2', 'AGDAL 1', 'AGDAL 2', 'HASSAN', 'SOUISSI', 'BOUREGRAG'],
            'MARRAKECH': ['CENTRE', 'GUELIZ'],
            'CASABLANCA': ['CENTRE 1', 'CENTRE 2', 'ANFA', 'YOUSSEF', 'LES ORANGERS', 'MAARIF', 'ROUDANI'],
            'FES': ['FES']
        };

        const updateCampusOptions = (villeSelect, campusSelect) => {
            const selectedVille = villeSelect.value;
            const campuses = campusOptions[selectedVille] || [];
            
            campusSelect.innerHTML = '<option value="">Sélectionnez un campus</option>';
            campuses.forEach(campus => {
                const option = document.createElement('option');
                option.value = campus;
                option.textContent = campus;
                campusSelect.appendChild(option);
            });
        };
        
        searchVilleInput.addEventListener('change', () => updateCampusOptions(searchVilleInput, searchCampusInput));
        submissionVilleInput.addEventListener('change', () => {
            updateCampusOptions(submissionVilleInput, submissionCampusActuelInput);
            updateCampusOptions(submissionVilleInput, submissionCampusDesireInput);
        });
        
        const setStatusMessage = (message, type) => {
            statusMessage.textContent = message;
            statusMessage.className = 'mb-4 p-4 text-center rounded-lg text-sm font-medium';
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-700', 'block');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-700', 'block');
            }
        };

        const showMessageBox = (message, isConfirm = false, onConfirm = null) => {
            messageText.textContent = message;
            messageBox.style.display = 'flex';
            if (isConfirm) {
                messageOkBtn.textContent = 'Oui';
                messageCancelBtn.classList.remove('hidden');
                messageOkBtn.onclick = () => {
                    messageBox.style.display = 'none';
                    if (onConfirm) onConfirm();
                };
                messageCancelBtn.onclick = () => {
                    messageBox.style.display = 'none';
                };
            } else {
                messageOkBtn.textContent = 'OK';
                messageCancelBtn.classList.add('hidden');
                messageOkBtn.onclick = () => {
                    messageBox.style.display = 'none';
                };
            }
        };

        const formatDate = (dateString) => {
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleDateString('fr-FR', options);
        };

        const createRequestCard = (data) => {
            const card = document.createElement('div');
            card.className = "bg-white p-4 rounded-xl shadow-md border border-green-200 flex flex-col justify-between";
            
            card.innerHTML = `
                <div class="space-y-2">
                    <p class="text-green-800 font-bold text-lg"><i class="fas fa-user-graduate mr-2 text-green-500"></i>${data.prenom} ${data.nom}</p>
                    <p class="text-gray-700"><i class="fas fa-chart-bar mr-2 text-green-500"></i>Niveau et filière: <span class="font-medium">${data.niveau}</span></p>
                    <p class="text-gray-700"><i class="fas fa-city mr-2 text-green-500"></i>Ville: <span class="font-medium">${data.ville}</span></p>
                    <p class="text-gray-700"><i class="fas fa-building-columns mr-2 text-green-500"></i>Campus actuel: <span class="font-medium">${data.classe}</span></p>
                    <p class="text-gray-700"><i class="fas fa-location-arrow mr-2 text-green-500"></i>Campus souhaité: <span class="font-medium text-green-600">${data.campusdesire}</span></p>
                    <p class="text-xs text-gray-500 mt-2"><i class="fas fa-clock mr-1"></i>Publié le: ${formatDate(data.created_at)}</p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between">
                    <p class="text-sm font-mono text-green-600" id="numero-${data.id}">
                        ${data.numero}
                    </p>
                    <div class="flex items-center space-x-2">
                        <button class="copy-btn bg-green-100 text-green-600 px-3 py-1 text-sm rounded-full font-medium hover:bg-green-200 transition duration-200" data-numero="${data.numero}">
                            <i class="fas fa-copy mr-1"></i> Copier
                        </button>
                        ${data.user_id === myUserId ? `
                            <button class="delete-btn bg-red-100 text-red-600 px-3 py-1 text-sm rounded-full font-medium hover:bg-red-200 transition duration-200" data-id="${data.id}">
                                <i class="fas fa-trash-alt mr-1"></i> Supprimer
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            return card;
        };

        const renderRequests = (requests) => {
            requestsList.innerHTML = '';
            if (requests.length === 0) {
                requestsList.innerHTML = '<p class="col-span-1 md:col-span-2 text-center text-gray-500 p-8">Aucune demande ne correspond à votre recherche.</p>';
            } else {
                requests.forEach(request => {
                    const card = createRequestCard(request);
                    requestsList.appendChild(card);
                });
            }
        };

        const filterRequests = () => {
            const selectedVille = searchVilleInput.value.toLowerCase();
            const selectedCampus = searchCampusInput.value.toLowerCase();

            const filteredRequests = allRequests.filter(req => {
                const villeMatch = selectedVille ? req.ville.toLowerCase().includes(selectedVille) : true;
                const campusMatch = selectedCampus ? req.campusdesire.toLowerCase().includes(selectedCampus) : true;
                return villeMatch && campusMatch;
            });

            renderRequests(filteredRequests);
        };

        searchVilleInput.addEventListener('change', filterRequests);
        searchCampusInput.addEventListener('change', filterRequests);

        requestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');

            const data = {
                prenom: document.getElementById('prenom').value,
                nom: document.getElementById('nom').value,
                niveau: document.getElementById('niveau').value,
                ville: submissionVilleInput.value,
            
                classe: submissionCampusActuelInput.value,
                campusdesire: submissionCampusDesireInput.value,
                numero: document.getElementById('numero').value,
                user_id: myUserId
            };

            try {
                const { error } = await supabase
                    .from('campus_swaps')
                    .insert([data]);

                if (error) throw error;
                
                requestForm.reset();
                showMessageBox("Votre demande a été publiée avec succès !");
            } catch (error) {
                console.error("Erreur détaillée de Supabase lors de l'insertion:", error);
                setStatusMessage("Échec de la publication. Vérifiez la configuration de votre base de données Supabase.", 'error');
            } finally {
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        });

        document.getElementById('clear-form-btn').addEventListener('click', () => {
            requestForm.reset();
        });

        requestsList.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-btn')) {
                const deleteButton = e.target.closest('.delete-btn');
                const requestId = deleteButton.dataset.id;
                showMessageBox("Êtes-vous sûr de vouloir supprimer cette demande ?", true, async () => {
                    try {
                        const { error } = await supabase
                            .from('campus_swaps')
                            .delete()
                            .eq('id', requestId);

                        if (error) throw error;
                        
                        showMessageBox("La demande a été supprimée avec succès !");
                    } catch (error) {
                        console.error("Erreur de Supabase lors de la suppression:", error);
                        showMessageBox("Échec de la suppression. Veuillez réessayer plus tard.");
                    }
                });
            }
        });

        document.getElementById('copy-link-btn').addEventListener('click', () => {
            const url = 'https://aymanefakihi.github.io/emsi-changement-de-campus/';
            const tempInput = document.createElement('textarea');
            document.body.appendChild(tempInput);
            tempInput.value = url;
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showMessageBox("Lien du site copié !");
        });

        const setupRealtimeListener = () => {
            supabase.channel('public-changes')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'campus_swaps' },
                    payload => {
                        console.log('Changement en temps réel (INSERT):', payload);
                        const newRequest = payload.new;
                        allRequests.unshift(newRequest); 
                        filterRequests();
                        totalRequestsSpan.textContent = allRequests.length;
                    })
                .on('postgres_changes',
                    { event: 'DELETE', schema: 'public', table: 'campus_swaps' },
                    payload => {
                        console.log('Changement en temps réel (DELETE):', payload);
                        const deletedId = payload.old.id;
                        allRequests = allRequests.filter(req => req.id !== deletedId);
                        filterRequests();
                        totalRequestsSpan.textContent = allRequests.length;
                    })
                .subscribe();
        };

        const fetchInitialRequests = async () => {
            loadingRequests.classList.remove('hidden');
            try {
                const { data, error } = await supabase
                    .from('campus_swaps')
                    .select('id, prenom, nom, niveau, ville, classe, campusdesire, numero, user_id, created_at')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                allRequests = data;
                loadingRequests.classList.add('hidden');
                totalRequestsSpan.textContent = allRequests.length;
                renderRequests(allRequests);
                
            } catch (error) {
                console.error("Erreur détaillée de Supabase lors du chargement initial:", error);
                loadingRequests.classList.add('hidden');
                setStatusMessage("Erreur lors du chargement des demandes. Vérifiez votre connexion et votre configuration Supabase.", 'error');
            }
        };

        window.onload = () => {
            if (supabaseUrl === 'YOUR_SUPABASE_URL' || supabaseAnonKey === 'YOUR_SUPABASE_ANON_KEY') {
                setStatusMessage("Veuillez d'abord configurer vos clés Supabase dans le code.", 'error');
            } else {
                fetchInitialRequests();
                setupRealtimeListener();
            }
        };

    </script>
</body>
</html>
